\doxysection{exchange.\+h}
\hypertarget{exchange_8h_source}{}\label{exchange_8h_source}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <numeric>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <stdexcept>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <iostream>}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}network.h"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}prime.h"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceexchange}{exchange}}\ \{}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00047\ \ \ uint64\_t\ \mbox{\hyperlink{namespaceexchange_ab37416384dcd834529cb06395e8ab9f2}{compute\_intermediary}}(\textcolor{keyword}{const}\ uint64\_t\&\ p,\ \textcolor{keyword}{const}\ uint64\_t\&\ g,\ \textcolor{keyword}{const}\ uint64\_t\&\ k)\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{comment}{//\ We\ can\ write\ the\ key\ as:\ k\ =\ (p-\/1)q\ +\ r}}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{comment}{//\ Which\ turns\ g**k\ \%\ p\ into\ g**((p-\/1)q\ +\ r)\ \%\ p}}
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{comment}{//\ By\ simplifying\ the\ exponent,\ we\ get\ ((g**(p-\/1))**q)g**r}}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{comment}{//\ According\ to\ Fermat's\ Little\ Theorem,\ g**(p-\/1)\ =\ 1,\ so}}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{comment}{//\ we\ can\ reduce\ all\ that\ down\ to\ g**r\ \%\ p.}}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ This\ only\ applies\ if\ p\ is\ co-\/prime\ to\ g.}}
\DoxyCodeLine{00054\ \ \ \ \ uint64\_t\ r\ =\ k\ \%\ (p\ -\/\ 1),\ q\ =\ (k\ -\/\ r)\ /\ (p\ -\/\ 1);}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceprime_afd42038a213dacfa2cf643b7fd78a180}{prime::raise}}(g,\ r,\ p);}
\DoxyCodeLine{00056\ \ \ \}}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00065\ \ \ uint64\_t\ \mbox{\hyperlink{namespaceexchange_a511ddac1db9f3e26b094bc0b765c0f65}{exchange\_keys}}(\textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\&\ server)\ \{}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{comment}{//\ Generate\ our\ private\ key,\ and\ the\ other\ user's\ intermediary.}}
\DoxyCodeLine{00067\ \ \ \ \ uint64\_t\ a\ =\ 0,\ k\ =\ std::rand(),\ p\ =\ 0,\ g\ =\ 0;}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keywordflow}{if}\ (server)\ \{}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \ \ \textcolor{comment}{//\ Firstly,\ we\ generate\ our\ p,\ which\ will\ be\ our\ mod\ value}}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \textcolor{comment}{//\ (And\ public),\ and\ then\ generate\ a\ q\ value,\ which\ we'll}}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \textcolor{comment}{//\ use\ for\ g.\ These\ follows\ the\ relationship\ p\ =\ jq\ +\ 1,}}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \textcolor{comment}{//\ Where\ j\ =\ 2.\ See\ 2.2\ of\ the\ Reference.}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \textcolor{comment}{//\ This\ ensures\ that\ p\ is\ a\ "{}safe\ prime,"{}\ which\ has\ the\ following}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{comment}{//\ helpful\ properties:}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{comment}{//\ \ 1.\ Every\ quadratic\ nonresidue\ is\ a\ primitive\ root\ (Which\ we\ need\ for\ g)}}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \textcolor{comment}{//\ \ 2.\ The\ least\ positive\ primitive\ root\ is\ a\ prime\ number.}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \textcolor{comment}{//\ What\ does\ this\ mean?\ It\ basically\ lets\ us\ quickly\ find\ an\ associated\ g}}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \textcolor{comment}{//\ value,\ rather\ than\ going\ through\ an\ expensive\ algorithm\ to\ compute}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \textcolor{comment}{//\ primitive\ roots\ for\ a\ number.}}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ pair\ =\ \mbox{\hyperlink{namespaceprime_a55b24169031fb8a19e7f1bc724a63fda}{prime::generate}}();}
\DoxyCodeLine{00083\ \ \ \ \ \ \ p\ =\ std::get<0>(pair);}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ q\ =\ std::get<1>(pair);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \ \ \textcolor{comment}{//\ Next,\ we\ calculate\ h,\ which\ we'll\ use\ to\ generate\ g.}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ simply\ need\ to\ find\ a\ number\ such\ that\ h\string^((p-\/1)/q)\ \%\ p}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \textcolor{comment}{//\ Is\ greater\ than\ one.\ (I\ think\ the\ Reference\ has\ a\ typo\ in}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \textcolor{comment}{//\ this\ section\ were\ they\ are\ missing\ the\ raise\ \string^).}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \textcolor{comment}{//\ Any\ interesting\ tibit\ of\ knowledge\ for\ you:}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \textcolor{comment}{//\ I've\ also\ found\ suggestions\ of\ generating\ g\ by\ omitting}}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \textcolor{comment}{//\ h,\ and\ simply\ taking\ the\ smallest\ primitive\ root\ of\ p.}}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ take\ the\ smallest\ because\ g\ should\ usually\ be\ small.}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \textcolor{comment}{//\ According\ to\ Wikipedia,\ this\ is:}}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \textcolor{comment}{//\ "{}Because\ of\ the\ random\ self-\/reducibility\ of\ the\ discrete}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \textcolor{comment}{//\ logarithm\ problem\ a\ small\ g\ is\ equally\ secure\ as\ any\ other}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \textcolor{comment}{//\ generator\ of\ the\ same\ group."{}}}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \textcolor{comment}{//\ -\/\ https://en.wikipedia.org/wiki/Diffie\%E2\%80\%93Hellman\_key\_exchange}}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \textcolor{comment}{//\ That\ being\ said,\ I\ had\ an\ implementation\ to\ find\ a\ primitive}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \textcolor{comment}{//\ root\ for\ a\ value\ p,\ which\ would\ ensure\ that\ g\ would\ be\ as\ small}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \textcolor{comment}{//\ as\ possible,\ but\ it\ was\ so\ SLOW.\ This\ method\ is\ lightning\ quick}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \textcolor{comment}{//\ Which\ is\ probably\ why\ the\ Reference\ suggests\ it.\ In\ fact,}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \textcolor{comment}{//\ there\ are\ probably\ far\ more\ efficient\ ways\ of\ generating\ h,}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \textcolor{comment}{//\ Since\ we're\ just\ brute\ forcing\ it\ here.}}
\DoxyCodeLine{00106\ \ \ \ \ \ \ uint64\_t\ h\ =\ 1;}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{namespaceprime_afd42038a213dacfa2cf643b7fd78a180}{prime::raise}}(h++,\ (p-\/1)/q,\ p)\ <=\ 1)\ \{\}}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \ \ \textcolor{comment}{//\ With\ an\ h,\ we\ can\ generate\ g.}}
\DoxyCodeLine{00110\ \ \ \ \ \ \ g\ =\ \mbox{\hyperlink{namespaceprime_afd42038a213dacfa2cf643b7fd78a180}{prime::raise}}(h,\ (p-\/1)/q,\ p);}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \textcolor{comment}{//\ Send\ them\ across.}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacenetwork_a8ce2596c5463ea3c6ddbdda72ae810f4}{network::send\_value}}(p)\ ==\ -\/1)}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ send\ key!"{}});}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacenetwork_a8ce2596c5463ea3c6ddbdda72ae810f4}{network::send\_value}}(g)\ ==\ -\/1)}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ send\ key!"{}});}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \ \ \textcolor{comment}{//\ Then,\ we\ send\ our\ intermediary,\ and\ receive\ the\ client.}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacenetwork_a8ce2596c5463ea3c6ddbdda72ae810f4}{network::send\_value}}(\mbox{\hyperlink{namespaceexchange_ab37416384dcd834529cb06395e8ab9f2}{exchange::compute\_intermediary}}(p,\ g,\ k))\ ==\ -\/1)}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ send\ key!"{}});}
\DoxyCodeLine{00121\ \ \ \ \ \ \ a\ =\ \mbox{\hyperlink{namespacenetwork_aece659d7f6b65d51b84c73a53c30f468}{network::recv\_value<uint64\_t>}}();}
\DoxyCodeLine{00122\ \ \ \ \ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \textcolor{comment}{//\ Collect\ the\ server's\ p,g,\ and\ intermediary.}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ p\ =\ \mbox{\hyperlink{namespacenetwork_aece659d7f6b65d51b84c73a53c30f468}{network::recv\_value<uint64\_t>}}();}
\DoxyCodeLine{00127\ \ \ \ \ \ \ g\ =\ \mbox{\hyperlink{namespacenetwork_aece659d7f6b65d51b84c73a53c30f468}{network::recv\_value<uint64\_t>}}();}
\DoxyCodeLine{00128\ \ \ \ \ \ \ a\ =\ \mbox{\hyperlink{namespacenetwork_aece659d7f6b65d51b84c73a53c30f468}{network::recv\_value<uint64\_t>}}();}
\DoxyCodeLine{00129\ }
\DoxyCodeLine{00130\ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ our\ intermediary,\ and\ send\ it\ back.}}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespacenetwork_a8ce2596c5463ea3c6ddbdda72ae810f4}{network::send\_value}}(\mbox{\hyperlink{namespaceexchange_ab37416384dcd834529cb06395e8ab9f2}{exchange::compute\_intermediary}}(p,\ g,\ k))\ ==\ -\/1)}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ send\ key!"{}});}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{//\ Both\ server\ and\ client\ can\ now\ calculate\ their\ shared\ key.}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keyword}{auto}\ sk\ =\ \mbox{\hyperlink{namespaceprime_afd42038a213dacfa2cf643b7fd78a180}{prime::raise}}(a,\ k,\ p);}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{return}\ sk;}
\DoxyCodeLine{00138\ \ \ \}}
\DoxyCodeLine{00139\ \}}

\end{DoxyCode}
